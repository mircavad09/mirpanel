<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mirpanel Admin</title>
  <link rel="stylesheet" href="style.css">

  <style>
    .admin-wrap{max-width:1100px;margin:18px auto;padding:0 10px;}
    .panel{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:18px;padding:14px;backdrop-filter:blur(10px);margin:12px 0;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:900;opacity:.9;font-size:13px}
    .field input,.field textarea, .field select{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.06);color:#fff;outline:none;font-weight:800;
    }
    textarea{min-height:90px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn2{border:none;cursor:pointer;font-weight:900;padding:10px 14px;border-radius:14px;transition:.2s}
    .btn-save{background:#facc15;color:#000}
    .btn-del{background:#ef4444;color:#fff}
    .btn-ghost{background:rgba(255,255,255,0.08);color:#fff}
    .note{opacity:.75;font-size:12px;line-height:1.35}
    .ok{color:#b7ffbf}
    .bad{color:#ffb7b7}
    @media(max-width:820px){.row,.row3{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="container admin-wrap">

    <div class="topbar">
      <h2>Admin Panel</h2>
      <p class="note">Gizli giriş: <b>/?panel=1</b> (index bu query-ni admin-ə yönləndirir)</p>
    </div>

    <!-- LOGIN -->
    <div class="panel" id="loginPanel">
      <div style="font-weight:900;font-size:16px;margin-bottom:6px">Giriş (10 rəqəmli kod)</div>
      <div class="note">Kod gündə 1 dəfə dəyişir. Daxil olandan sonra 24 saat kod istəməyəcək.</div>

      <div class="actions" style="margin-top:12px">
        <input id="code" style="min-width:220px" maxlength="10" placeholder="**********" inputmode="numeric"/>
        <button class="btn2 btn-save" id="loginBtn">Daxil ol</button>
        <span id="loginMsg" class="note"></span>
      </div>
    </div>

    <!-- MAIN -->
    <div id="mainPanel" style="display:none">

      <div class="panel">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div style="font-weight:900;font-size:16px">Config + Services</div>
            <div class="note">“Yadda saxla” → preview + JSON faylları download → GitHub-a upload edib saytı yenilə</div>
          </div>
          <div class="actions">
            <button class="btn2 btn-ghost" id="goSite">Əsas sayta keç</button>
            <button class="btn2 btn-ghost" id="logout">Çıxış</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin-bottom:10px">Sayt ayarları (config.json)</h3>

        <div class="row">
          <div class="field">
            <label>Brand adı</label>
            <input id="brandName" placeholder="Mirpanel">
          </div>
          <div class="field">
            <label>Logo yolu (məs: assets/logo.png)</label>
            <input id="logo" placeholder="assets/logo.png">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>WhatsApp nömrə (yalnız rəqəm)</label>
            <input id="whatsappPhone" placeholder="9945...">
          </div>
          <div class="field">
            <label>Footer mətn</label>
            <input id="footer" placeholder="©️ 2026 Mirpanel">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>SEO Title</label>
            <input id="seoTitle" placeholder="...">
          </div>
          <div class="field">
            <label>SEO Description</label>
            <input id="seoDesc" placeholder="...">
          </div>
        </div>

        <div class="field">
          <label>SEO Keywords</label>
          <input id="seoKeywords" placeholder="premium, netflix, spotify ...">
        </div>

        <div class="field">
          <label>Kateqoriyalar (JSON kimi) — toxunmaq istəmirsənsə buranı elə saxla</label>
          <textarea id="categories"></textarea>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin-bottom:10px">Xidmətlər (services.json)</h3>

        <div class="note" style="margin-bottom:10px">
          Format: <b>JSON</b> — hər item: id, cat, title, img, cornerPrice, desc, info, plans[{name,price}]<br>
          Rahat olsun deyə burada tam JSON edit edirsən.
        </div>

        <div class="field">
          <label>services.json məzmunu</label>
          <textarea id="servicesJson" style="min-height:240px"></textarea>
        </div>

        <div class="actions">
          <button class="btn2 btn-save" id="saveAll">Yadda saxla + Faylları yüklə</button>
          <button class="btn2 btn-ghost" id="downloadCfg">Yalnız config.json yüklə</button>
          <button class="btn2 btn-ghost" id="downloadSrv">Yalnız services.json yüklə</button>
          <span id="saveMsg" class="note"></span>
        </div>

        <div class="note" style="margin-top:10px">
          GitHub update: Repo-da köhnə <b>config.json</b> və <b>services.json</b> fayllarını bununla əvəz et → commit → sayt yenilənəcək.
        </div>
      </div>

    </div>
  </div>

  <script>
    // ====== SECURITY (statik üçün "kifayət qədər") ======
    // Burdakı SECRET-i mütləq dəyiş! (çox uzun et)
    const ADMIN_SECRET = "CHANGE_THIS_SECRET_TO_SOMETHING_LONG_AND_PRIVATE_!_2026";

    const SESSION_KEY = "MP_ADMIN_SESSION_V1";
    const LS_CFG = "MP_CFG_PREVIEW_V1";
    const LS_SRV = "MP_SERVICES_PREVIEW_V1";

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    async function sha256Hex(str){
      const data = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,"0")).join("");
    }
    async function dailyCode10(){
      const hex = await sha256Hex(ADMIN_SECRET + "|" + todayKey());
      let digits = "";
      for(let i=0;i<hex.length && digits.length<10;i++){
        const c = hex[i];
        if(c>="0" && c<="9") digits += c;
        else digits += String("abcdef".indexOf(c)); // a-f -> 0-5
      }
      return digits.padEnd(10,"0");
    }

    function setSession24h(){
      localStorage.setItem(SESSION_KEY, JSON.stringify({exp: Date.now() + 24*60*60*1000}));
    }
    function isSessionValid(){
      try{
        const s = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
        return s && s.exp && Date.now() < s.exp;
      }catch(e){ return false; }
    }
    function clearSession(){
      localStorage.removeItem(SESSION_KEY);
    }

    function downloadFile(name, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function safeFetchJSON(url){
      try{
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      }catch(e){ return null; }
    }

    function showMain(){
      document.getElementById("loginPanel").style.display = "none";
      document.getElementById("mainPanel").style.display = "";
    }
    function showLogin(){
      document.getElementById("loginPanel").style.display = "";
      document.getElementById("mainPanel").style.display = "none";
    }

    function fillCfgForm(cfg){
      document.getElementById("brandName").value = cfg.brandName || "";
      document.getElementById("logo").value = cfg.logo || "";
      document.getElementById("footer").value = cfg.footer || "";
      document.getElementById("whatsappPhone").value = cfg.whatsappPhone || "";
      document.getElementById("seoTitle").value = cfg.seoTitle || "";
      document.getElementById("seoDesc").value = cfg.seoDesc || "";
      document.getElementById("seoKeywords").value = cfg.seoKeywords || "";
      document.getElementById("categories").value = JSON.stringify(cfg.categories || [], null, 2);
    }

    function readCfgForm(){
      let categories = [];
      try{ categories = JSON.parse(document.getElementById("categories").value || "[]"); }catch(e){ categories = []; }

      return {
        brandName: (document.getElementById("brandName").value || "").trim(),
        logo: (document.getElementById("logo").value || "").trim(),
        footer: (document.getElementById("footer").value || "").trim(),
        whatsappPhone: (document.getElementById("whatsappPhone").value || "").replace(/\D/g,""),
        seoTitle: (document.getElementById("seoTitle").value || "").trim(),
        seoDesc: (document.getElementById("seoDesc").value || "").trim(),
        seoKeywords: (document.getElementById("seoKeywords").value || "").trim(),
        categories
      };
    }

    function fillServicesForm(srv){
      document.getElementById("servicesJson").value = JSON.stringify(srv, null, 2);
    }
    function readServicesForm(){
      return JSON.parse(document.getElementById("servicesJson").value || "{}");
    }

    async function loadInitial(){
      // Preview varsa onu göstər, yoxdursa fayldan oxu
      const cfgPreview = localStorage.getItem(LS_CFG);
      const srvPreview = localStorage.getItem(LS_SRV);

      const cfgFile = await safeFetchJSON("config.json");
      const srvFile = await safeFetchJSON("services.json");

      const cfg = cfgPreview ? JSON.parse(cfgPreview) : (cfgFile || {});
      const srv = srvPreview ? JSON.parse(srvPreview) : (srvFile || {items:[]});

      fillCfgForm(cfg);
      fillServicesForm(srv);
    }

    // ====== EVENTS ======
    document.getElementById("goSite").onclick = () => location.href = "index.html";
    document.getElementById("logout").onclick = () => {
      clearSession();
      showLogin();
      document.getElementById("loginMsg").innerHTML = `<span class="note ok">Çıxış edildi ✅</span>`;
    };

    document.getElementById("loginBtn").onclick = async () => {
      const want = (document.getElementById("code").value || "").trim();
      const code = await dailyCode10();
      if(want === code){
        setSession24h();
        document.getElementById("loginMsg").innerHTML = `<span class="note ok">Daxil oldun ✅ (24 saat aktiv)</span>`;
        showMain();
        loadInitial();
      }else{
        document.getElementById("loginMsg").innerHTML = `<span class="note bad">Kod səhvdir ❌</span>`;
      }
    };

    function savePreview(cfg, srv){
      localStorage.setItem(LS_CFG, JSON.stringify(cfg));
      localStorage.setItem(LS_SRV, JSON.stringify(srv));
    }

    document.getElementById("saveAll").onclick = () => {
      const msg = document.getElementById("saveMsg");
      msg.textContent = "";

      let cfg, srv;
      try{
        cfg = readCfgForm();
        srv = readServicesForm();
        if(!srv || typeof srv !== "object") throw new Error("services.json format səhvdir");
        if(!Array.isArray(srv.items)) throw new Error("services.json içində items[] olmalıdır");
      }catch(e){
        msg.innerHTML = `<span class="bad">Xəta: ${e.message}</span>`;
        return;
      }

      // 1) preview
      savePreview(cfg, srv);

      // 2) download files for GitHub
      downloadFile("config.json", cfg);
      downloadFile("services.json", srv);

      msg.innerHTML = `<span class="ok">Yadda saxlandı ✅ Fayllar yükləndi ✅</span>`;
      setTimeout(()=>msg.textContent="", 2000);
    };

    document.getElementById("downloadCfg").onclick = () => {
      const cfg = readCfgForm();
      downloadFile("config.json", cfg);
    };
    document.getElementById("downloadSrv").onclick = () => {
      const srv = readServicesForm();
      downloadFile("services.json", srv);
    };

    // ====== INIT ======
    (async function init(){
      if(isSessionValid()){
        showMain();
        await loadInitial();
      }else{
        showLogin();
      }
      // istəsən bugünkü kodu konsolda gör:
      // console.log(await dailyCode10());
    })();
  </script>
</body>
</html>